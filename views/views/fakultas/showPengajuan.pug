extends ../layout/master

block sidebar
    ul.navbar-nav.bg-gradient-primary.sidebar.sidebar-dark.accordion(id="accordionSidebar")
        a.sidebar-brand.d-flex.align-items-center.justify-content-center(href="index.html")
            .sidebar-brand-icon.rotate-n-15
                i.fas.fa-laugh-wink
            .sidebar-brand-text.mx-3 SB Admin sup 2

        hr.sidebar-divider.my-0

        li.nav-item.active
            a.nav-link(href="index.html")
                i.fas.fa-fw.fa-tachometer-alt
                span Dashboard

        hr.sidebar-divider

        .sidebar-heading Interface

        li.nav-item
            a.nav-link.collapsed(href="#", data-toggle="collapse", data-target="#collapseTwo", aria-expanded="true", aria-controls="collapseTwo")
                i.fas.fa-fw.fa-cog
                span Components
            #collapseTwo.collapse(aria-labelledby="headingTwo", data-parent="#accordionSidebar")
                .bg-white.py-2.collapse-inner.rounded
                    h6.collapse-header Beasiswa :
                    a.collapse-item(href="/prodi/pengajuan") Lihat Pengajuan
                    a.collapse-item(href="/mahasiswa/pengajuan") Pendaftaran
                    a.collapse-item(href="/mahasiswa/history") Riwayat Pengajuan

block top-bar
    nav.navbar.navbar-expand.navbar-light.bg-white.topbar.mb-4.static-top.shadow
        button#sidebarToggleTop.btn.btn-link.d-md-none.rounded-circle.mr-3
            i.fa.fa-bars

        form.d-none.d-sm-inline-block.form-inline.mr-auto.ml-md-3.my-2.my-md-0.mw-100.navbar-search
            .input-group
                input.form-control.bg-light.border-0.small(type="text", placeholder="Search for...", aria-label="Search", aria-describedby="basic-addon2")
                .input-group-append
                    button.btn.btn-primary(type="button")
                        i.fas.fa-search.fa-sm

        ul.navbar-nav.ml-auto
            li.nav-item.dropdown.no-arrow.d-sm-none
                a.nav-link.dropdown-toggle(href="#", id="searchDropdown", role="button", data-toggle="dropdown", aria-haspopup="true", aria-expanded="false")
                    i.fas.fa-search.fa-fw
                .dropdown-menu.dropdown-menu-right.p-3.shadow.animated--grow-in(aria-labelledby="searchDropdown")
                    form.form-inline.mr-auto.w-100.navbar-search
                        .input-group
                            input.form-control.bg-light.border-0.small(type="text", placeholder="Search for...", aria-label="Search", aria-describedby="basic-addon2")
                            .input-group-append
                                button.btn.btn-primary(type="button")
                                    i.fas.fa-search.fa-sm

            li.nav-item.dropdown.no-arrow.mx-1
                a.nav-link.dropdown-toggle(href="#", id="alertsDropdown", role="button", data-toggle="dropdown", aria-haspopup="true", aria-expanded="false")
                    i.fas.fa-bell.fa-fw
                    span.badge.badge-danger.badge-counter 3+
                .dropdown-list.dropdown-menu.dropdown-menu-right.shadow.animated--grow-in(aria-labelledby="alertsDropdown")
                    h6.dropdown-header Alerts Center
                    a.dropdown-item.d-flex.align-items-center(href="#")
                        .mr-3
                            .icon-circle.bg-primary
                                i.fas.fa-file-alt.text-white
                        .div
                            .small.text-gray-500 December 12, 2019
                            span.font-weight-bold A new monthly report is ready to download!
                    a.dropdown-item.d-flex.align-items-center(href="#")
                        .mr-3
                            .icon-circle.bg-success
                                i.fas.fa-donate.text-white
                        .div
                            .small.text-gray-500 December 7, 2019
                            | $290.29 has been deposited into your account!
                    a.dropdown-item.d-flex.align-items-center(href="#")
                        .mr-3
                            .icon-circle.bg-warning
                                i.fas.fa-exclamation-triangle.text-white
                        .div
                            .small.text-gray-500 December 2, 2019
                            | Spending Alert: We've noticed unusually high spending for your account.
                    a.dropdown-item.text-center.small.text-gray-500(href="#") Show All Alerts

            li.nav-item.dropdown.no-arrow.mx-1
                a.nav-link.dropdown-toggle(href="#", id="messagesDropdown", role="button", data-toggle="dropdown", aria-haspopup="true", aria-expanded="false")
                    i.fas.fa-envelope.fa-fw
                    span.badge.badge-danger.badge-counter 7
                .dropdown-list.dropdown-menu.dropdown-menu-right.shadow.animated--grow-in(aria-labelledby="messagesDropdown")
                    h6.dropdown-header Message Center
                    a.dropdown-item.d-flex.align-items-center(href="#")
                        .dropdown-list-image.mr-3
                            img.rounded-circle(src="/img/undraw_profile_1.svg", alt="...")
                            .status-indicator.bg-success
                        .font-weight-bold
                            .text-truncate Hi there! I am wondering if you can help me with a problem I've been having.
                            .small.text-gray-500 Emily Fowler 路 58m
                    a.dropdown-item.d-flex.align-items-center(href="#")
                        .dropdown-list-image.mr-3
                            img.rounded-circle(src="/img/undraw_profile_2.svg", alt="...")
                            .status-indicator
                        .div
                            .text-truncate I have the photos that you ordered last month, how would you like them sent to you?
                            .small.text-gray-500 Jae Chun 路 1d
                    a.dropdown-item.d-flex.align-items-center(href="#")
                        .dropdown-list-image.mr-3
                            img.rounded-circle(src="/img/undraw_profile_3.svg", alt="...")
                            .status-indicator.bg-warning
                        .div
                            .text-truncate Last month's report looks great, I am very happy with the progress so far, keep up the good work!
                            .small.text-gray-500 Morgan Alvarez 路 2d
                    a.dropdown-item.d-flex.align-items-center(href="#")
                        .dropdown-list-image.mr-3
                            img.rounded-circle(src="https://source.unsplash.com/Mv9hjnEUHR4/60x60", alt="...")
                            .status-indicator.bg-success
                        .div
                            .text-truncate Am I a good boy? The reason I ask is because someone told me that people say this to all dogs, even if they aren't good...
                            .small.text-gray-500 Chicken the Dog 路 2w
                    a.dropdown-item.text-center.small.text-gray-500(href="#") Read More Messages

            .topbar-divider.d-none.d-sm-block

            li.nav-item.dropdown.no-arrow
                a.nav-link.dropdown-toggle(href="#", id="userDropdown", role="button", data-toggle="dropdown", aria-haspopup="true", aria-expanded="false")
                    span.mr-2.d-none.d-lg-inline.text-gray-600.small Douglas McGee
                    img.img-profile.rounded-circle(src="/img/undraw_profile.svg")
                .dropdown-menu.dropdown-menu-right.shadow.animated--grow-in(aria-labelledby="userDropdown")
                    a.dropdown-item(href="#")
                        i.fas.fa-user.fa-sm.fa-fw.mr-2.text-gray-400
                        | Profile
                    a.dropdown-item(href="#")
                        i.fas.fa-cogs.fa-sm.fa-fw.mr-2.text-gray-400
                        | Settings
                    a.dropdown-item(href="#")
                        i.fas.fa-list.fa-sm.fa-fw.mr-2.text-gray-400
                        | Activity Log
                    .dropdown-divider
                    a.dropdown-item(href="#", data-toggle="modal", data-target="#logoutModal")
                        i.fas.fa-sign-out-alt.fa-sm.fa-fw.mr-2.text-gray-400
                        | Logout

block web-content
    h1 Pengajuan Beasiswa

    if pengajuan && pengajuan.length
        table.table.table-bordered.table-hover
            thead
                tr
                    th Pengajuan ID
                    th NRP
                    th Beasiswa ID
                    th Periode ID
                    th Tanggal Pengajuan
                    th Status Pengajuan
                    th Status Pengajuan Fakultas
                    th Dokumen Pengajuan
                    th Action
                    th Detail Mahasiswa
            tbody
                each p in pengajuan
                    tr
                        td= p.pengajuan_id
                        td= p.nrp
                        td= p.beasiswa_id
                        td= p.periode_id
                        td= p.tanggal_pengajuan
                        td= p.status_pengajuan
                        td= p.status_pengajuan_fakultas
                        td
                            a(href=`/prodi/download/${pengajuan.dokumen_pengajuan}`) Download
                        td
                            if p.status_pengajuan == 'Disetujui Prodi'
                                button.btn.btn-success.btn-sm(data-toggle="modal", data-target=`#confirmApproveModal${pengajuan.pengajuan_id}`) Approved
                                button.btn.btn-danger.btn-sm(data-toggle="modal", data-target=`#confirmDeclineModal${pengajuan.pengajuan_id}`) Declined
                            else
                                p Belum Disetujui Prodi
                        td
                            button.btn.btn-info.btn-sm(data-toggle="modal", data-target=`#mahasiswaDetailModal${pengajuan.nrp}`) Lihat Detail

    else
        p Tidak ada data pengajuan yang ditemukan.

    each p in pengajuan
        .modal.fade(id=`mahasiswaDetailModal${p.nrp}`, tabindex="-1", role="dialog", aria-labelledby="exampleModalLabel", aria-hidden="true")
            .modal-dialog(role="document")
                .modal-content
                    .modal-header
                        h5.modal-title#exampleModalLabel Detail Mahasiswa
                        button.close(type="button", data-dismiss="modal", aria-label="Close")
                            span(aria-hidden="true") &times;
                    .modal-body
                        dl
                            dt NRP
                            dd= p.nrp
                            dt Nama
                            dd= p.nama_mahasiswa
                            dt Program Studi ID
                            dd= p.program_studi_id
                            dt IPK Terakhir
                            dd= p.ipk_terakhir
                            dt Status Aktif
                            dd= p.status_aktif
                    .modal-footer
                        button.btn.btn-secondary(type="button", data-dismiss="modal") Close

    each p in pengajuan
        .modal.fade(id=`confirmApproveModal${p.pengajuan_id}`, tabindex="-1", role="dialog", aria-labelledby="approveModalLabel", aria-hidden="true")
            .modal-dialog(role="document")
                .modal-content
                    .modal-header
                        h5.modal-title#approveModalLabel Konfirmasi Approved
                        button.close(type="button", data-dismiss="modal", aria-label="Close")
                            span(aria-hidden="true") &times;
                    .modal-body
                        p Apakah Anda yakin ingin menyetujui pengajuan dengan ID #{p.pengajuan_id}?
                    .modal-footer
                        button.btn.btn-secondary(type="button", data-dismiss="modal") Cancel
                        button.btn.btn-success(type="button", onclick=`approvePengajuan(${p.pengajuan_id})`) Confirm Approved

    each p in pengajuan
        .modal.fade(id=`confirmDeclineModal${p.pengajuan_id}`, tabindex="-1", role="dialog", aria-labelledby="declineModalLabel", aria-hidden="true")
            .modal-dialog(role="document")
                .modal-content
                    .modal-header
                        h5.modal-title#declineModalLabel Konfirmasi Declined
                        button.close(type="button", data-dismiss="modal", aria-label="Close")
                            span(aria-hidden="true") &times;
                    .modal-body
                        p Apakah Anda yakin ingin menolak pengajuan dengan ID #{p.pengajuan_id}?
                    .modal-footer
                        button.btn.btn-secondary(type="button", data-dismiss="modal") Cancel
                        button.btn.btn-danger(type="button", onclick=`declinePengajuan(${p.pengajuan_id})`) Confirm Declined


    // Modal Konfirmasi Setelah Tindakan
    .modal.fade(id="actionConfirmationModal", tabindex="-1", role="dialog", aria-labelledby="actionConfirmationModalLabel", aria-hidden="true")
        .modal-dialog(role="document")
            .modal-content
                .modal-header
                    h5.modal-title#actionConfirmationModalLabel Konfirmasi
                    button.close(type="button", data-dismiss="modal", aria-label="Close")
                        span(aria-hidden="true") &times;
                .modal-body
                    if actionStatus == 'approved'
                        p Pengajuan dengan ID #{actionPengajuanId} telah disetujui.
                    else if actionStatus == 'declined'
                        p Pengajuan dengan ID #{actionPengajuanId} telah ditolak.
                .modal-footer
                    button.btn.btn-secondary(type="button", data-dismiss="modal") Close

    script.
        document.addEventListener("DOMContentLoaded", function() {
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');
            const pengajuan_id = urlParams.get('pengajuan_id');

            if (status) {
                const modal = new bootstrap.Modal(document.getElementById('actionConfirmationModal'));
                document.getElementById('actionConfirmationModalLabel').textContent = status === 'approved' ? 'Approved' : 'Declined';
                const modalBody = document.querySelector('#actionConfirmationModal .modal-body p');
                modalBody.textContent = status === 'approved'
                    ? `Pengajuan dengan ID ${pengajuan_id} telah disetujui.`
                    : `Pengajuan dengan ID ${pengajuan_id} telah ditolak.`;
                modal.show();
            }
        });


        function approvePengajuan(pengajuanId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "You want to approve this pengajuan?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, approve it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/fakultas/pengajuan/approve/${pengajuanId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ pengajuan_id: pengajuanId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 200) {
                            Swal.fire(
                                'Approved!',
                                'Pengajuan has been approved.',
                                'success'
                            ).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire(
                                'Error!',
                                data.message,
                                'error'
                            );
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire(
                            'Error!',
                            'An error occurred while approving the pengajuan.',
                            'error'
                        );
                    });
                }
            });
        }

        function declinePengajuan(pengajuanId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "You want to decline this pengajuan?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, decline it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/fakultas/pengajuan/decline/${pengajuanId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ pengajuan_id: pengajuanId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 200) {
                            Swal.fire(
                                'Declined!',
                                'Pengajuan has been declined.',
                                'success'
                            ).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire(
                                'Error!',
                                data.message,
                                'error'
                            );
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire(
                            'Error!',
                            'An error occurred while declining the pengajuan.',
                            'error'
                        );
                    });
                }
            });
        }

